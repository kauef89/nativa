import { defineStore } from "pinia";
import api from "../services/api";
import { notify } from "@/services/notify";

export const useDeliveryStore = defineStore("delivery", {
  state: () => ({
    // Dados do Cliente
    customerName: "",
    customerPhone: "",
    
    // Dados de Endereço
    selectedStreet: null, // Objeto rua (do autocomplete)
    streetNumber: "",
    complement: "",
    reference: "",

    // Resultado do Cálculo
    calculatedBairro: null,
    deliveryFee: 0.0,
    freeShippingThreshold: 0.0,
    
    // Estados de UI Principais
    isSearching: false,
    isCalculating: false,
    streetSuggestions: [], // Lista para o Autocomplete

    // --- ESTADOS PARA O MODAL DE CADASTRO RÁPIDO ---
    showCreateStreetModal: false, // Controla a visibilidade do Dialog
    newStreetName: "",            // Nome da rua a ser criada
    availableBairros: [],         // Lista de bairros para o Dropdown
    isCreatingStreet: false,      // Loading do botão de salvar
  }),

  getters: {
    // Valida se pode iniciar o pedido (precisa ter rua, número e bairro calculado)
    isValidAddress: (state) => {
      return !!state.selectedStreet && !!state.streetNumber && !!state.calculatedBairro;
    },
    
    finalFee: (state) => {
      return state.deliveryFee;
    }
  },

  actions: {
    // 1. Busca Ruas (Autocomplete)
    async searchStreets(query) {
      if (!query || query.length < 3) return;
      
      // this.isSearching = true; // Opcional (o PrimeVue já tem loading nativo)
      try {
        const response = await api.get(`/search-address?q=${query}`);
        if (response.data.success) {
          this.streetSuggestions = response.data.results;
        }
      } catch (error) {
        console.error("Erro ao buscar ruas", error);
      } finally {
        this.isSearching = false;
      }
    },

    // 2. Calcula Frete (Rua + Número)
    async calculateFreight() {
      // Validações básicas
      if (!this.selectedStreet || !this.streetNumber) return;
      
      // Se o usuário selecionou a opção de "Criar Rua" (ID especial), não calcula nada ainda
      if (this.selectedStreet.id === 'new_street') return;

      this.isCalculating = true;
      this.calculatedBairro = null; // Reseta para forçar atualização visual
      
      try {
        const response = await api.post("/calculate-freight", {
          rua_id: this.selectedStreet.id,
          numero: this.streetNumber
        });

        if (response.data.success) {
          this.calculatedBairro = response.data.bairro;
          this.deliveryFee = parseFloat(response.data.taxa);
          this.freeShippingThreshold = parseFloat(response.data.frete_gratis_acima_de);
          
          notify("success", "Endereço Localizado", `Bairro: ${this.calculatedBairro}`);
        } else {
            // Caso a rua exista mas o número esteja fora da área/faixa
            notify("warn", "Atenção", response.data.message || "Endereço fora da área de entrega.");
        }
      } catch (error) {
        notify("error", "Erro", "Falha ao calcular taxa de entrega.");
        console.error(error);
      } finally {
        this.isCalculating = false;
      }
    },

    // 3. Limpa tudo (Reset completo)
    reset() {
      this.customerName = "";
      this.customerPhone = "";
      this.selectedStreet = null;
      this.streetNumber = "";
      this.complement = "";
      this.reference = "";
      this.calculatedBairro = null;
      this.deliveryFee = 0;
      this.streetSuggestions = [];
    },

    // --- AÇÕES DO MODAL DE NOVA RUA ---

    // Busca a lista de bairros para preencher o Dropdown do modal
    async fetchBairros() {
        // Cache simples: se já buscou, não busca de novo
        if (this.availableBairros.length > 0) return; 
        
        try {
            const response = await api.get('/bairros');
            if (response.data.success) {
                this.availableBairros = response.data.bairros;
            }
        } catch (e) { 
            console.error('Erro ao buscar lista de bairros', e);
            notify("error", "Erro", "Não foi possível carregar os bairros.");
        }
    },

    // Cria a rua no banco e já a seleciona na tela
    async createStreet(bairroId) {
        if (!this.newStreetName || !bairroId) return;
        
        this.isCreatingStreet = true;
        try {
            const response = await api.post('/create-street', {
                name: this.newStreetName,
                bairro_id: bairroId
            });

            if (response.data.success) {
                notify("success", "Sucesso", "Rua cadastrada e vinculada!");
                
                // Fecha o modal
                this.showCreateStreetModal = false;
                
                // Define a rua recém-criada como a selecionada no formulário
                this.selectedStreet = response.data.rua;
                
                // Pequeno hack de UX: Foca no campo de número
                setTimeout(() => {
                    const numInput = document.querySelector('input[placeholder="Nº"]');
                    if (numInput) numInput.focus();
                }, 200);
            }
        } catch (error) {
            console.error(error);
            notify("error", "Erro", "Não foi possível cadastrar a rua.");
        } finally {
            this.isCreatingStreet = false;
        }
    }
  },
});